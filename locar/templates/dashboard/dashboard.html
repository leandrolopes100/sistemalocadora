{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="p-6 space-y-10">

  <!-- üîπ Cabe√ßalho -->
  <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-semibold text-gray-900">Painel de Gest√£o</h1>
      <p class="text-gray-500 text-sm mt-1">Acompanhe m√©tricas, desempenho financeiro e status geral da sua frota e clientes.</p>
    </div>
  </header>

 <!-- üîπ Filtro de Data -->
<div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-5 mb-8">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-lg font-medium text-gray-800">Filtrar Per√≠odo</h2>
  </div>

  <form method="get" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
    <!-- Data Inicial -->
    <div>
      <label class="block text-sm font-medium text-gray-600 mb-1">Data Inicial</label>
      <div class="relative">
        <input
          type="date"
          name="data_inicio"
          value="{{ data_inicio }}"
          class="w-full border border-gray-300 rounded-lg pl-3 pr-10 py-2 text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition"
        />
        <span class="absolute right-3 top-2.5 text-gray-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v11a2 2 0 002 2z" />
          </svg>
        </span>
      </div>
    </div>

    <!-- Data Final -->
    <div>
      <label class="block text-sm font-medium text-gray-600 mb-1">Data Final</label>
      <div class="relative">
        <input
          type="date"
          name="data_fim"
          value="{{ data_fim }}"
          class="w-full border border-gray-300 rounded-lg pl-3 pr-10 py-2 text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition"
        />
        <span class="absolute right-3 top-2.5 text-gray-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v11a2 2 0 002 2z" />
          </svg>
        </span>
      </div>
    </div>

    <!-- Bot√£o -->
    <div class="flex items-end">
        <button type="submit"
          class="inline-flex items-center gap-2 rounded-lg bg-amber-500 text-white font-medium px-4 py-2 text-sm hover:bg-amber-600 focus:ring-2 focus:ring-amber-400 transition"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" class="w-5 h-5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 110-15 7.5 7.5 0 010 15z" />
          </svg>
          Aplicar Filtro
        </button>
      </div>
        </form>
      </div>

  <!-- üîπ Cards Financeiros -->
  <section>
    <h2 class="text-lg font-semibold text-gray-800 mb-3">Resumo Financeiro</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100 shadow-sm">
        <p class="text-gray-600 text-sm font-medium">Total a Receber</p>
        <h3 class="text-2xl font-bold text-blue-700 mt-1">R$ {{ resumo.total_receber|floatformat:2|intcomma }}</h3>
      </div>

      <div class="bg-green-50 p-5 rounded-2xl border border-green-100 shadow-sm">
        <p class="text-gray-600 text-sm font-medium">Total Recebido</p>
        <h3 class="text-2xl font-bold text-green-700 mt-1">R$ {{ resumo.total_pago|floatformat:2|intcomma }}</h3>
      </div>

      <div class="bg-red-50 p-5 rounded-2xl border border-red-100 shadow-sm">
        <p class="text-gray-600 text-sm font-medium">Despesas</p>
        <h3 class="text-2xl font-bold text-red-700 mt-1">R$ {{ resumo.total_despesas|floatformat:2|intcomma }}</h3>
      </div>

      <div class="bg-emerald-50 p-5 rounded-2xl border border-emerald-100 shadow-sm">
        <p class="text-gray-600 text-sm font-medium">Lucro L√≠quido</p>
        <h3 class="text-2xl font-bold text-emerald-700 mt-1">R$ {{ resumo.lucro_liquido|floatformat:2|intcomma }}</h3>
      </div>
    </div>
  </section>

   <!-- üîπ Cards de Indicadores Gerais -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="bg-gray-100 p-5 rounded-2xl border border-gray-200 shadow-sm">
      <div class="text-sm text-gray-500 font-medium">Ve√≠culos Totais</div>
      <div class="text-3xl font-bold text-gray-800 mt-1">{{ total_veiculos|intcomma }}</div>
    </div>

    <div class="bg-gray-100 p-5 rounded-2xl border border-gray-200 shadow-sm">
      <div class="text-sm text-gray-500 font-medium">Ve√≠culos Alugados</div>
      <div class="text-3xl font-bold text-gray-800 mt-1">{{ veiculos_alugados|intcomma }}</div>
    </div>

    <div class="bg-gray-100 p-5 rounded-2xl border border-gray-200 shadow-sm">
      <div class="text-sm text-gray-500 font-medium">Loca√ß√µes Ativas</div>
      <div class="text-3xl font-bold text-gray-800 mt-1">{{ locacoes_ativas|intcomma }}</div>
    </div>

    <div class="bg-gray-100 p-5 rounded-2xl border border-gray-200 shadow-sm">
      <div class="text-sm text-gray-500 font-medium">Clientes Totais</div>
      <div class="text-3xl font-bold text-gray-800 mt-1">{{ total_clientes|intcomma }}</div>
    </div>
    
  </section>


  <!-- üîπ Gr√°fico -->
  <section class="bg-white p-6 rounded-2xl shadow border border-gray-100">
    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" viewBox="0 0 20 20" fill="currentColor">
        <path d="M2 11a1 1 0 011-1h2v6H3a1 1 0 01-1-1v-4zm6-3a1 1 0 011-1h2v9H9a1 1 0 01-1-1V8zm6-5a1 1 0 011-1h2v14h-2a1 1 0 01-1-1V3z" />
      </svg>
      Pagamentos por Dia da Semana
    </h2>
    <canvas id="pagamentosChart" class="w-full" style="height: 240px;"></canvas>
  </section>

  <!-- üîπ Tabela de Valores Recebidos -->
  <section class="bg-white p-6 rounded-2xl shadow border border-gray-100">
    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" viewBox="0 0 20 20" fill="currentColor">
        <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm.25-11a2 2 0 012 2 2 2 0 01-2 2H9.5v1h1.5a2 2 0 010 4H9a2 2 0 01-2-2h1.5a.5.5 0 000-1H8a2 2 0 010-4h1.25v-1H8a2 2 0 010-4h2.25z" />
      </svg>
      Hist√≥rico de Recebimentos
    </h2>

    <div class="overflow-x-auto rounded-xl border border-gray-100">
      <table class="min-w-full text-sm text-left">
        <thead class="bg-gray-50 text-gray-700 uppercase text-xs">
          <tr>
            <th class="px-4 py-3">Loca√ß√£o</th>
            <th class="px-4 py-3">Cliente</th>
            <th class="px-4 py-3">Ve√≠culo</th>
            <th class="px-4 py-3 text-right">Valor Total</th>
            <th class="px-4 py-3 text-right text-green-700">Recebido</th>
            <th class="px-4 py-3 text-center">Semanas</th>
            <th class="px-4 py-3 text-center">Pr√≥x. Pagamento</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for dia, locs in pagamentos_por_dia.items %}
            {% for item in locs %}
              {% if item.semanas_pagas > 0 %}
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 font-medium text-gray-800">#{{ item.locacao.id }}</td>
                <td class="px-4 py-3">{{ item.cliente }}</td>
                <td class="px-4 py-3">{{ item.veiculo }}</td>
                <td class="px-4 py-3 text-right">R$ {{ item.locacao.valor_total_locacao|floatformat:2|intcomma }}</td>
                <td class="px-4 py-3 text-right font-semibold text-green-600">R$ {{ item.valor_recebido|floatformat:2|intcomma }}</td>
                <td class="px-4 py-3 text-center">{{ item.semanas_pagas }} / {{ item.locacao.quantidade_semanas }}</td>
                <td class="px-4 py-3 text-center">
                  <span class="inline-flex items-center px-3 py-1 text-xs font-semibold text-gray-700 bg-gray-100 rounded-full">
                    {{ item.proximo_pagamento|date:"d/m/Y" }}
                  </span>
                </td>
              </tr>
              {% endif %}
            {% endfor %}
          {% empty %}
          <tr>
            <td colspan="7" class="px-4 py-6 text-center text-gray-500 italic">Nenhum recebimento registrado.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>

<!-- üîπ Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('pagamentosChart').getContext('2d');
const labels = {{ labels_chart|safe }};
const data = {
  labels: labels,
  datasets: [{
    label: 'Loca√ß√µes',
    data: {{ data_chart|safe }},
    backgroundColor: 'rgba(59,130,246,0.7)',
    borderColor: 'rgba(37,99,235,1)',
    borderWidth: 1,
    borderRadius: 6,
  }]
};
new Chart(ctx, {
  type: 'bar',
  data: data,
  options: {
    responsive: true,
    plugins: {
      legend: { display: false },
      title: { display: false }
    },
    scales: {
      y: { beginAtZero: true, ticks: { precision: 0 } }
    }
  }
});
</script>
{% endblock %}
